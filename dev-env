#!/usr/bin/env bash
set -e

# Source platform detection
script_dir=$(cd $(dirname "${BASH_SOURCE[0]}") && pwd)
source "$script_dir/runs/_platform.sh"

OS=$(detect_os)

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
GRAY='\033[0;90m'
BOLD='\033[1m'
RESET='\033[0m'

dry="0"
filter=""

# Parse arguments
while [[ $# > 0 ]]; do
  if [[ $1 == "--dry" ]]; then
    dry="1"
  else
    filter="$1"
  fi
  shift
done

# Header
echo -e "${BOLD}${BLUE}Dev Env Copier${RESET}"
echo -e "Directory: ${CYAN}${script_dir}${RESET}"
echo -e "Platform: ${CYAN}${OS}${RESET}"

if [ -z "$XDG_CONFIG_HOME" ]; then
  echo -e "XDG_CONFIG_HOME: ${CYAN}~/.config (default)${RESET}"
  XDG_CONFIG_HOME=$HOME/.config
else
  echo -e "XDG_CONFIG_HOME: ${CYAN}${XDG_CONFIG_HOME}${RESET}"
fi

if [[ -n "$filter" ]]; then
  echo -e "Filter: ${CYAN}${filter}${RESET}"
fi

if [[ $dry == "1" ]]; then
  echo -e "Mode: ${YELLOW}${BOLD}DRY RUN${RESET}"
fi
echo ""

log() {
  if [[ $dry == "1" ]]; then
    echo -e "${YELLOW}[DRY]${RESET} $@"
  else
    echo -e "${BLUE}[RUN]${RESET} $@"
  fi
}

log_success() {
  echo -e "${GREEN}✓${RESET} $@"
}

log_skip() {
  echo -e "${GRAY}○${RESET} ${GRAY}$@${RESET}"
}

execute() {
  log "$@"
  if [[ $dry == "1" ]]; then
    return 0
  fi
  "$@"
}

copy_config() {
  local name="$1"
  local src="$script_dir/dotfiles/.config/$name"
  local dest="$XDG_CONFIG_HOME/$name"

  if [[ ! -e "$src" ]]; then
    echo -e "${RED}✗${RESET} Source not found: $src"
    return 1
  fi

  execute mkdir -p "$XDG_CONFIG_HOME"
  execute rm -rf "$dest"
  execute cp -r "$src" "$dest"
  log_success "Copied .config/$name"
}

# Configs for all platforms
SHARED_CONFIGS=(
  "tmux"
  "ghostty"
  "nvim"
  "lazygit"
  "bat"
  "yazi"
  "opencode"
)

# Linux-only configs
LINUX_CONFIGS=(
  "i3"
  "i3blocks"
  "rofi"
  "picom"
)

# Mac-only configs (add as needed)
MAC_CONFIGS=(
)

# Copy shared configs
for config in "${SHARED_CONFIGS[@]}"; do
  if [[ -n "$filter" && "$config" != *"$filter"* ]]; then
    log_skip "Skipped: $config"
    continue
  fi
  copy_config "$config"
done

# Copy platform-specific configs
if [[ "$OS" == "linux" ]]; then
  for config in "${LINUX_CONFIGS[@]}"; do
    if [[ -n "$filter" && "$config" != *"$filter"* ]]; then
      log_skip "Skipped: $config"
      continue
    fi
    copy_config "$config"
  done
elif [[ "$OS" == "mac" ]]; then
  for config in "${MAC_CONFIGS[@]}"; do
    if [[ -n "$filter" && "$config" != *"$filter"* ]]; then
      log_skip "Skipped: $config"
      continue
    fi
    copy_config "$config"
  done
fi

# Copy .local/scripts
LOCAL_SCRIPTS_SRC="$script_dir/dotfiles/.local/scripts"
LOCAL_SCRIPTS_DEST="$HOME/.local/scripts"

if [[ -d "$LOCAL_SCRIPTS_SRC" ]]; then
  if [[ -z "$filter" || "scripts" == *"$filter"* ]]; then
    execute mkdir -p "$HOME/.local"
    execute rm -rf "$LOCAL_SCRIPTS_DEST"
    execute cp -r "$LOCAL_SCRIPTS_SRC" "$LOCAL_SCRIPTS_DEST"
    execute chmod +x "$LOCAL_SCRIPTS_DEST"/*
    log_success "Copied .local/scripts"
  fi
fi

# Copy shell config
DOTFILES_SH_SRC="$script_dir/dotfiles/.dotfiles.sh"
BASHRC_SRC="$script_dir/dotfiles/.bashrc"

if [[ -z "$filter" || "shell" == *"$filter"* || "bashrc" == *"$filter"* || "zshrc" == *"$filter"* ]]; then
  # Always copy .dotfiles.sh (works with both bash and zsh)
  if [[ -f "$DOTFILES_SH_SRC" ]]; then
    execute cp "$DOTFILES_SH_SRC" "$HOME/.dotfiles.sh"
    log_success "Copied .dotfiles.sh"
  fi

  # On Linux, also copy .bashrc
  if [[ "$OS" == "linux" && -f "$BASHRC_SRC" ]]; then
    execute cp "$BASHRC_SRC" "$HOME/.bashrc"
    log_success "Copied .bashrc"
  fi
fi

echo ""
echo -e "${GREEN}${BOLD}Done!${RESET}"

# On Mac, ensure .zshrc sources .dotfiles.sh
if [[ "$OS" == "mac" ]]; then
  ZSHRC="$HOME/.zshrc"
  SOURCE_LINE='source ~/.dotfiles.sh'

  if [[ -f "$ZSHRC" ]]; then
    if grep -q "source ~/.dotfiles.sh" "$ZSHRC" 2>/dev/null; then
      echo -e "${GREEN}✓${RESET} .zshrc already sources .dotfiles.sh"
    else
      if [[ $dry == "1" ]]; then
        echo -e "${YELLOW}[DRY]${RESET} Would append 'source ~/.dotfiles.sh' to .zshrc"
      else
        echo "" >> "$ZSHRC"
        echo "# Dotfiles configuration" >> "$ZSHRC"
        echo "$SOURCE_LINE" >> "$ZSHRC"
        echo -e "${GREEN}✓${RESET} Added 'source ~/.dotfiles.sh' to .zshrc"
      fi
    fi
  else
    if [[ $dry == "1" ]]; then
      echo -e "${YELLOW}[DRY]${RESET} Would create .zshrc with 'source ~/.dotfiles.sh'"
    else
      echo "# Dotfiles configuration" > "$ZSHRC"
      echo "$SOURCE_LINE" >> "$ZSHRC"
      echo -e "${GREEN}✓${RESET} Created .zshrc with 'source ~/.dotfiles.sh'"
    fi
  fi
fi
