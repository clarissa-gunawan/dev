#!/usr/bin/env bash
set -e

# Source platform detection
script_dir=$(cd $(dirname "${BASH_SOURCE[0]}") && pwd)
source "$script_dir/runs/_platform.sh"

OS=$(detect_os)

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
GRAY='\033[0;90m'
BOLD='\033[1m'
RESET='\033[0m'

# Symbols
CHECK="✓"
CROSS="✗"
SKIP="○"
ARROW="→"

runs_dir="$script_dir/runs"
filters=()
dry="0"
executed_count=0
skipped_count=0
success_count=0
failed_count=0
successful_scripts=()
failed_scripts=()

# Parse arguments
while [[ $# > 0 ]]; do
  if [[ $1 == "--dry" ]]; then
    dry="1"
  elif [[ $1 == "--optional" ]]; then
    runs_dir="$script_dir/runs_optional"
  else
    filters+=("$1")
  fi
  shift
done

# Header
echo -e "${BOLD}${BLUE}Installation Script Runner${RESET}"
echo -e "Directory: ${CYAN}${script_dir}${RESET}"
echo -e "Platform: ${CYAN}${OS}${RESET}"

if [[ ${#filters[@]} -gt 0 ]]; then
  echo -e "Filter: ${CYAN}${filters[*]}${RESET}"
else
  echo -e "Filter: ${CYAN}\"\"${RESET}"
fi

if [[ $dry == "1" ]]; then
  echo -e "Mode: ${YELLOW}${BOLD}DRY RUN${RESET}"
fi
echo ""

log() {
  if [[ $dry == "1" ]]; then
    echo -e "${YELLOW}[DRY]${RESET} $@"
  else
    echo -e "${BLUE}[RUN]${RESET} $@"
  fi
}

log_skip() {
  echo -e "${GRAY}${SKIP}${RESET} ${GRAY}$@${RESET}"
}

log_execute() {
  echo -e "${GREEN}${ARROW}${RESET} ${BOLD}$@${RESET}"
}

# Find script path - platform-specific takes precedence over common
find_script() {
  local name="$1"
  local base_dir="$2"

  # Check platform-specific first
  if [[ -x "$base_dir/$OS/$name" ]]; then
    echo "$base_dir/$OS/$name"
  # Then check common
  elif [[ -x "$base_dir/common/$name" ]]; then
    echo "$base_dir/common/$name"
  fi
}

execute() {
  local script_path="$1"
  local script_name=$(basename "$script_path")
  local script_location=$(dirname "$script_path" | xargs basename)

  log_execute "Executing: $script_name (from $script_location/)"

  log "$script_path"
  if [[ $dry == "1" ]]; then
    successful_scripts+=("$script_name")
    success_count=$((success_count + 1))
    return 0
  fi

  if "$script_path"; then
    echo -e "${GREEN}${CHECK}${RESET} ${GREEN}Success${RESET}"
    successful_scripts+=("$script_name")
    success_count=$((success_count + 1))
    return 0
  else
    echo -e "${RED}${CROSS}${RESET} ${RED}Failed${RESET}"
    failed_scripts+=("$script_name")
    failed_count=$((failed_count + 1))
    return 1
  fi
}

cd "$script_dir"

# Collect all unique script names from common/ and $OS/
script_names=""

# Scan common directory
if [[ -d "$runs_dir/common" ]]; then
  for script in "$runs_dir/common"/*; do
    [[ -x "$script" && -f "$script" ]] || continue
    script_names="$script_names $(basename "$script")"
  done
fi

# Scan platform-specific directory
if [[ -d "$runs_dir/$OS" ]]; then
  for script in "$runs_dir/$OS"/*; do
    [[ -x "$script" && -f "$script" ]] || continue
    script_names="$script_names $(basename "$script")"
  done
fi

# Remove duplicates and sort
script_names=$(echo "$script_names" | tr ' ' '\n' | sort -u | grep -v '^$')

if [[ -z "$script_names" ]]; then
  echo -e "${YELLOW}No executable scripts found in $runs_dir/common or $runs_dir/$OS${RESET}"
  exit 1
fi

# Process scripts in sorted order
for script_name in $script_names; do
  # Find the script path (platform takes precedence)
  script_path=$(find_script "$script_name" "$runs_dir")

  if [[ -z "$script_path" ]]; then
    continue
  fi

  matches_filter=false
  if [[ ${#filters[@]} -eq 0 ]]; then
    matches_filter=true
  else
    for filter in "${filters[@]}"; do
      if echo "$script_name" | grep -q "$filter"; then
        matches_filter=true
        break
      fi
    done
  fi

  if [[ "$matches_filter" == false ]]; then
    log_skip "Skipped: $script_name"
    skipped_count=$((skipped_count + 1))
    echo ""
    continue
  fi

  execute "$script_path"
  executed_count=$((executed_count + 1))
  echo ""
done

# Summary
echo -e "${BOLD}Summary${RESET}"

if [[ ${#successful_scripts[@]} -gt 0 ]]; then
  echo -e "${GREEN}${BOLD}Successful (${success_count}):${RESET}"
  for script in "${successful_scripts[@]}"; do
    echo -e "  ${GREEN}${CHECK}${RESET} $script"
  done
fi

if [[ ${#failed_scripts[@]} -gt 0 ]]; then
  echo -e "${RED}${BOLD}Failed (${failed_count}):${RESET}"
  for script in "${failed_scripts[@]}"; do
    echo -e "  ${RED}${CROSS}${RESET} $script"
  done
fi

if [[ $skipped_count -gt 0 ]]; then
  echo -e "${GRAY}${BOLD}Skipped: ${skipped_count}${RESET}"
fi

echo -e "${BLUE}${BOLD}Total Installations: ${executed_count}${RESET}"
echo ""
